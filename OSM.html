<!DOCTYPE html>
<html>

<head>
  <title>View Rotation</title>
  <style type="text/css">
    html,
    body,
    #map {
      position: relative;
      width: 100%;
      height: 100%;
      margin: 0;
    }
  </style>
  <link rel="stylesheet" href="https://openlayers.org/en/v4.2.0/css/ol.css" type="text/css">
  <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://openlayers.org/en/v4.2.0/build/ol.js"></script>
  <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <body onload="init();">
    <div id="map" class="map">
      <div id="popup"></div>
    </div>
  </body>
  <script>
    var rotation = 0;
    var pos = {
      lat: -34.397,
      lng: 150.644
    };
    var zoom = 14;
    var view = new ol.View({
      center: ol.proj.transform([pos.lng, pos.lat], 'EPSG:4326', 'EPSG:3857'),
      rotation: rotation,
      zoom: zoom
    });

    var map = new ol.Map({
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      target: document.getElementById('map'),
      controls: ol.control.defaults({
        attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
          collapsible: false
        })
      }),
      view: view
    });
    var markerLayer;

    function init() {

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            //    drawCurrentPos();
            //    drawKnownPlaces();
            //  nearbySearch();

            /*
                  var markers = new OpenLayers.Layer.Markers("Markers");
                  map.addLayer(markers);
                  markers.addMarker(new OpenLayers.Marker(position));
            */

            var iconFeature = new ol.Feature({
              geometry: new ol.geom.Point(ol.proj.transform([pos.lng, pos.lat], 'EPSG:4326', 'EPSG:3857')),
              name: 'Hier bin ich',
              population: 4000,
              rainfall: 500
            });

            var iconStyle = new ol.style.Style({
              image: new ol.style.Icon( /** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
              }))
            });

            iconFeature.setStyle(iconStyle);

            var vectorSource = new ol.source.Vector({
              features: [iconFeature]
            });

            var vectorLayer = new ol.layer.Vector({
              source: vectorSource
            });

            map.addLayer(vectorLayer);
            drawKnownPlaces();

            //  map.setCenter(lonLat, zoom);
            console.log(ol.proj.get());
            console.log("center" + [pos.lng, pos.lat]);
            map.getView().setCenter(ol.proj.transform([pos.lng, pos.lat], 'EPSG:4326', 'EPSG:3857'));

          },
          function() {
            //TODO:  handleLocationError(true, infoWindow, map.getCenter());
          });
      } else {
        // Browser doesn't support Geolocation
        //TODO:  handleLocationError(false, infoWindow, map.getCenter());
      }

      var element = document.getElementById('popup');
      // Popup showing the position the user clicked
      var popup = new ol.Overlay({
        element: element,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -50]
      });
      map.addOverlay(popup);

      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
          function(feature) {
            return feature;
          });
        if (feature) {
          var coordinates = feature.getGeometry().getCoordinates();
          popup.setPosition(coordinates);
          $(element).popover({
            'placement': 'top',
            'html': true,
            'content': feature.get('name')
          });
          $(element).popover('show');
        } else {
          $(element).popover('destroy');
        }
      });



    }

    var places = [{
        lng: 8.809172,
        lat: 53.074748,
        icon: './icons/landmark.png'
      },
      {
        lng: 8.769332,
        lat: 53.098145,
        icon: './icons/start.png'
      },
      {
        lng: 8.878000,
        lat: 53.097930,
        icon: './icons/home.png'
      },
      {
        lng: 8.805053,
        lat: 53.074786,
        icon: './icons/finish.png'
      }
    ];

    async function drawKnownPlaces() {
      await clearMarkers();
      var vs = [];
      for (var i = 0; i < places.length; i++) {
        console.log(new ol.geom.Point([places[i].lng, places[i].lat]));
        var iconFeature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.transform([places[i].lng, places[i].lat], 'EPSG:4326', 'EPSG:3857')),
          name: 'undefined',
          population: 4000,
          rainfall: 500
        });

        var iconStyle = new ol.style.Style({
          image: new ol.style.Icon( /** @type {olx.style.IconOptions} */ ({
            //size: [50, 50],
            scale: 0.1,
            src: places[i].icon
          }))
        });
        console.log(iconFeature.geometry);
        iconFeature.setStyle(iconStyle);
        vs.push(iconFeature);
      }
      console.log(vs);


      var vectorSource = new ol.source.Vector({
        features: vs
      });

      vectorLayer = new ol.layer.Vector({
        source: vectorSource
      });
      markerLayer = vectorLayer;
      map.addLayer(vectorLayer);
    }

    function clearMarkers() {
      if (markerLayer) {
        map.removeLayer(markerLayer);
      }
    }
    var defaultOrientation;
    // called on device orientation change
    function onHeadingChange(event) {

      console.log("WAS MACHST DU");
      var heading = event.alpha;

      if (typeof event.webkitCompassHeading !== "undefined") {
        heading = event.webkitCompassHeading; //iOS non-standard
      }

      var orientation = getBrowserOrientation();

      if (typeof heading !== "undefined" && heading !== null) { // TODO && typeof orientation !== "undefined") {
        // we have a browser that reports device heading and orientation


        // what adjustment we have to add to rotation to allow for current device orientation
        var adjustment = 0;
        if (defaultOrientation === "landscape") {
          adjustment -= 90;
        }

        if (typeof orientation !== "undefined") {
          var currentOrientation = orientation.split("-");

          if (defaultOrientation !== currentOrientation[0]) {
            if (defaultOrientation === "landscape") {
              adjustment -= 270;
            } else {
              adjustment -= 90;
            }
          }

          if (currentOrientation[1] === "secondary") {
            adjustment -= 180;
          }
        }
        rotaion = heading + adjustment;
        view.setRotation(rotation)

      }
    }
    window.addEventListener("deviceorientation", onHeadingChange);
  </script>
</head>






</html>
